<?php     require_once("root.inc.php");     require_once($ROOT."library/bitFunc.lib.php");     require_once($ROOT."library/auth.cls.php");     require_once($ROOT."library/textEncrypt.cls.php");     require_once($ROOT."library/datamodel.cls.php");     require_once($ROOT."library/dateFunc.lib.php");     require_once($ROOT."library/currFunc.lib.php");     require_once($APLICATION_ROOT."library/view.cls.php");               $view = new CView($_SERVER['PHP_SELF'],$_SERVER['QUERY_STRING']);	   $dtaccess = new DataAccess();     $enc = new textEncrypt();     $auth = new CAuth();     $err_code = 0;     $userData = $auth->GetUserData();     $skr = getDateToday();      	    if(!$auth->IsAllowed("laboratorium",PRIV_CREATE)){          die("access_denied");          exit(1);     } else if($auth->IsAllowed("laboratorium",PRIV_CREATE)===1){          echo"<script>window.parent.document.location.href='".$APLICATION_ROOT."login.php?msg=Login First'</script>";          exit(1);     }  $pemeriksaanId = $_GET["pemeriksaan_id"];  $_POST['pemeriksaan_id'] = $_GET["pemeriksaan_id"];    $sql = "select a.*,f.kategori_nama,cast(a.pemeriksaan_create as date) as tanggal_periksa,c.dokter_nama,           c.id_divisi, d.usr_name,e.kegiatan_nama, b.pemeriksaan_hasil, b.periksa_det_total,b.periksa_det_id,b.id_kegiatan, b.id_pemeriksaan, b.pemeriksaan_nilai_normal          from lab_pemeriksaan a          left join lab_pemeriksaan_detail b on b.id_pemeriksaan = a.pemeriksaan_id          left join lab_dokter c on c.dokter_id = a.id_dokter          left join global.global_auth_user d on d.usr_id=a.who_update          left join lab_kegiatan e on e.kegiatan_id = b.id_kegiatan          left join lab_kategori f on f.kategori_id = e.id_kategori          where pemeriksaan_id = ".QuoteValue(DPE_CHAR,$pemeriksaanId)."          order by f.kategori_nama";          //echo $sql;  $rs = $dtaccess->Execute($sql,DB_SCHEMA_LAB);  $data_pemeriksaan = $dtaccess->FetchAll($rs);       $totalItem = 0;  $totalService = 0;  $GrandTotal = 0;  if($_POST["btnUpdate"]) {     if(!$_POST["pemeriksaan_kwt"] && $_POST["btnUpdate"]) {          $sql = "select max(CAST(substring(pemeriksaan_kwt from 5 for 7) as BIGINT)) as kode from laboratorium.lab_pemeriksaan";          $lastKode = $dtaccess->Fetch($sql);          $_POST["pemeriksaan_kwt"] = str_pad($lastKode["kode"]+1,6,"0",STR_PAD_LEFT);         }$jumlahdata = $_POST['jumlah'] ;$pemeriksaanId = $_POST['pemeriksaanThok'];//masukan biaya lab ke folio          $sql = "select a.pemeriksaan_id , a.id_reg , a.id_cust_usr , c.kegiatan_nama , c.kegiatan_id , c.kegiatan_biaya  from laboratorium.lab_pemeriksaan a left join laboratorium.lab_pemeriksaan_detail b on b.id_pemeriksaan = a.pemeriksaan_idleft join laboratorium.lab_kegiatan c on c.kegiatan_id = b.id_kegiatan where pemeriksaan_id = ".QuoteValue(DPE_CHAR,$pemeriksaanId);            $rs = $dtaccess->Execute($sql);          $dataKegiatan = $dtaccess->FetchAll($rs);          for($i=0,$n=count($dataKegiatan);$i<$n;$i++) {                    $dbTable = "klinik.klinik_folio";          $dbField[0] = "fol_id";   // PK          $dbField[1] = "id_reg";          $dbField[2] = "fol_nama";          $dbField[3] = "fol_nominal";          $dbField[4] = "fol_jenis";          $dbField[5] = "id_cust_usr";          $dbField[6] = "fol_waktu";          $dbField[7] = "fol_lunas";          $dbField[8] = "id_biaya";          $dbField[9] = "fol_jumlah";           $dbField[10] = "fol_nominal_satuan";                                   $folId = $dtaccess->GetTransID();               $dbValue[0] = QuoteValue(DPE_CHARKEY,$folId);               $dbValue[1] = QuoteValue(DPE_CHARKEY,$dataKegiatan[$i]["id_reg"]);               $dbValue[2] = QuoteValue(DPE_CHARKEY,$dataKegiatan[$i]["kegiatan_nama"]);               $dbValue[3] = QuoteValue(DPE_NUMERIC,StripCurrency($dataKegiatan[$i]["kegiatan_biaya"]));               $dbValue[4] = QuoteValue(DPE_CHARKEY,'ZB');               $dbValue[5] = QuoteValue(DPE_CHARKEY,$dataKegiatan[$i]["id_cust_usr"]);               $dbValue[6] = QuoteValue(DPE_DATE,date("Y-m-d H:i:s"));               $dbValue[7] = QuoteValue(DPE_CHARKEY,"n");               $dbValue[8] = QuoteValue(DPE_CHARKEY,$dataKegiatan[$i]["kegiatan_id"]);               $dbValue[9] = QuoteValue(DPE_NUMERIC,'1');                $dbValue[10] = QuoteValue(DPE_NUMERIC,StripCurrency($dataKegiatan[$i]["kegiatan_biaya"]));                              $dbKey[0] = 0; // -- set key buat clause wherenya , valuenya = index array buat field / value               $dtmodel = new DataModel($dbTable,$dbField,$dbValue,$dbKey);               $dtmodel->Insert() or die("insert  error");                              unset($dbField);               unset($dtmodel);               unset($dbValue);               unset($dbKey);						$dbTable = "klinik_folio_split";											$dbField[0] = "folsplit_id";   // PK						$dbField[1] = "id_fol";						$dbField[2] = "id_split";						$dbField[3] = "folsplit_nominal";							  						$dbValue[0] = QuoteValue(DPE_CHAR,$dtaccess->GetTransID());						$dbValue[1] = QuoteValue(DPE_CHAR,$folId);						$dbValue[2] = QuoteValue(DPE_CHAR, "5"); //split laboratorium id nya lima buka klinik.klinik_split						$dbValue[3] = QuoteValue(DPE_NUMERIC,StripCurrency($dataKegiatan[$i]["kegiatan_biaya"]));						 						$dbKey[0] = 0; // -- set key buat clause wherenya , valuenya = index array buat field / value						$dtmodel = new DataModel($dbTable,$dbField,$dbValue,$dbKey,DB_SCHEMA_KLINIK);												$dtmodel->Insert() or die("insert error"); 												unset($dtmodel);						unset($dbField);						unset($dbValue);						unset($dbKey); }for($i=0,$n=$jumlahdata;$i<$n;$i++){		$sql = "update laboratorium.lab_pemeriksaan_detail set pemeriksaan_hasil = ".QuoteValue(DPE_CHAR,$_POST['hasil'][$i]). " , pemeriksaan_nilai_normal = ".QuoteValue(DPE_CHAR,$_POST['nilai'][$i]).    "where id_kegiatan = ".QuoteValue(DPE_CHAR,$_POST['kegiatan'][$i])."and id_pemeriksaan = ".QuoteValue(DPE_CHAR,$pemeriksaanId) ;                $dtaccess->Execute($sql);          }                                  $sql = "update laboratorium.lab_pemeriksaan set pemeriksaan_kwt = ".QuoteValue(DPE_CHAR,$_POST["pemeriksaan_kwt"]).    "where pemeriksaan_id = ".QuoteValue(DPE_CHAR,$pemeriksaanId) ;                $dtaccess->Execute($sql);       $cetakPage = "pemeriksaan_cetak.php?pemeriksaan_id=".$pemeriksaanId;        header ("location:".$cetakPage);}        ?><html>  <head>    <title>Kuitansi Pemeriksaan Laboratorium</title>    <script type="text/javascript">            /*  function cetak(){        if(confirm('cetak nota?')){          window.print();          }        kembali();        }*/            function kembali(){        document.location.href = 'pemeriksaan_edit.php';      }    </script>    <?php echo $view->RenderBody("inosoft.css",false); ?>  </head>  <body onLoad="cetak();">  <form name="frmEdit" method="POST" action="<?php echo $_SERVER["PHP_SELF"]?>">  <table border="0" cellpadding="2" cellspacing="0" style="align:left" width="500">    <tr>      <td rowspan="3" width="25%" class="tablecontent"><img src="<?echo $APLICATION_ROOT;?>/images/logo_bkmm1.gif" width="160" height="80"/></td>      <td style="text-align:left;font-size:18px;font-family:sans-serif;font-weight:bold;" class="tablecontent">LABORATORIUM</td>    </tr>    <tr>      <td style="text-align:left;font-size:14px;font-family:sans-serif;font-weight:bold;" class="tablecontent">BKMM</td>    </tr>    <!--<tr>      <td style="text-align:left;font-size:14px;font-family:sans-serif;font-weight:bold;" class="tablecontent">Jl. Gayung Kebonsari Timur 49, Surabaya</td>    </tr>-->  </table>  <br />  <br />  <table border="0" cellpadding="2" cellspacing="0" style="align:left" width="500">    <tr>      <td class="tablecontent">Tanggal</td>      <td class="tablecontent-odd">:&nbsp;<?php echo format_date_long($data_pemeriksaan[0]["tanggal_periksa"]);?>    </tr>    <tr>      <td class="tablecontent">Pasien</td>      <td class="tablecontent-odd">:&nbsp;<?php echo $data_pemeriksaan[0]["pemeriksaan_pasien_nama"];?>    </tr>    <tr>      <td class="tablecontent">Dokter</td>      <td class="tablecontent-odd">:&nbsp;<?php echo ($data_pemeriksaan[0]["dokter_nama"])?$data_pemeriksaan[0]["dokter_nama"]:"Permintaan Sendiri";?></td>    </tr>  </table>  <br />  <table border="1" cellpadding="1" cellspacing="0" style="align:left" width="400" style="border-style:double;">    <?php for($i=0;$i<count($data_pemeriksaan);$i++){             if($data_pemeriksaan[$i]["kategori_nama"]!=$data_pemeriksaan[$i-1]["kategori_nama"]){        ?>      <tr>        <td class="tablecontent"  width="100%" colspan="2">&nbsp;&nbsp;&nbsp;&nbsp;<?php echo $data_pemeriksaan[$i]["kategori_nama"] ?></td>        <td class="tablecontent" align="center">Hasil</td>        <td class="tablecontent" align="center">Nilai Normal</td>      </tr>    <?php }?>    <tr>      <td class="tablecontent" width="30%" colspan="2">&nbsp;<?php echo $data_pemeriksaan[$i]["kegiatan_nama"]; ?></td>      <!--<td class="tablecontent-odd" style="text-align:right">Rp.&nbsp;<?php echo currency_format($data_pemeriksaan[$i]["periksa_det_total"]);?>&nbsp;</td>-->      <td class="tablecontent-odd">      <input type="text" size="50" maxlength="255" name="hasil[<?php echo $i ?>]" id="hasil_<?php echo $i ;?>" >      </td>      <td class="tablecontent-odd">      <input type="text" size="50" maxlength="255" name="nilai[<?php echo $i ?>]" id="nilai_<?php echo $i ;?>" >      </td>    </tr>    <input type="hidden" name="kegiatan[<?php echo $i ?>]" value="<?php echo $data_pemeriksaan[$i]["id_kegiatan"]?>"  class="button">    <?php }?>  </table>  <br />  <input type="hidden" name="pemeriksaanThok" value="<?php echo $_POST['pemeriksaan_id']?>"  class="button">  <input type="hidden" name="jumlah" class="button" value="<?php echo count($data_pemeriksaan) ; ?>"  class="button">  <table border="1" cellpadding="1" cellspacing="0" style="align:left" width="400" style="border-style:double;">    <tr>      <td class="tablecontent" width="30%">&nbsp;Jumlah</td>      <td class="tablecontent-odd" style="text-align:right">&nbsp;Rp.&nbsp;<?php echo currency_format($data_pemeriksaan[0]["pemeriksaan_total"]); ?></td>    </tr>    <tr>      <td class="" width="30%">&nbsp;</td>      <td class="" style="text-align:right">            <input type="submit" name="btnUpdate" value="Simpan" class="button"></td>    </tr>          </table>  <br />  <table border="0" align="left" cellpadding="1" cellspacing="1" width="500">    <tr>      <td height="120" style="font-family:sans-serif;text-align:right;text-decoration:underline;" class="tablecontent"><?php echo $data_pemeriksaan[0]["usr_name"];?></td>    </tr>  </form>  </body></html>