<?php     require_once("root.inc.php");     require_once($ROOT."library/bitFunc.lib.php");     require_once($ROOT."library/auth.cls.php");     require_once($ROOT."library/textEncrypt.cls.php");     require_once($ROOT."library/datamodel.cls.php");     require_once($ROOT."library/inoLiveX.php");	   require_once($APLICATION_ROOT."library/view.cls.php");		   require_once($ROOT."library/currFunc.lib.php");          $view = new CView($_SERVER['PHP_SELF'],$_SERVER['QUERY_STRING']);     $dtaccess = new DataAccess();     $enc = new textEncrypt();     	   $auth = new CAuth();     $err_code = 0;          $userData = $auth->GetUserData();      $table = new InoTable("table","100%","left");		  $plx = new InoLiveX("CheckData");	     if(!$auth->IsAllowed("pos_pembelian",PRIV_READ)){          die("access_denied");          exit(1);               } elseif($auth->IsAllowed("pos_pembelian",PRIV_READ)===1){          echo"<script>window.parent.document.location.href='".$GLOBAL_ROOT."login.php?msg=Session Expired'</script>";          exit(1);     }		function CheckData($itemNama,$pembelianId=null)	{          global $dtaccess;                    $sql = "SELECT item_id FROM pos_item a                     WHERE upper(a.item_nama) = ".QuoteValue(DPE_CHAR,strtoupper($itemNama));                              if ($pembelianId) $sql .= " and a.item_id <> ".QuoteValue(DPE_CHAR,$pembelianId);                    $rs = $dtaccess->Execute($sql);          $dataAdaItem = $dtaccess->Fetch($rs);        		return $dataAdaItem["item_id"];     }      		if($_POST["x_mode"]) $_x_mode = & $_POST["x_mode"];	else $_x_mode = "New";   	if($_POST["pembelian_id"])  $pembelianId = & $_POST["pembelian_id"];	if($_POST["transaksi_id"])  {     $transaksiId = & $_POST["transaksi_id"];   $updateData = true;  }      $backPage = "pembelian_view.php?";     $backPageGagal = "pembelian_view.php?DelBatal=1";     $findPage = "item_find.php?";     if ($_GET["id"]) {          if ($_POST["btnDelete"]) {                $_x_mode = "Delete";          } else {                $_x_mode = "Edit";               $pembelianId = $enc->Decode($_GET["id"]);          }                   $sql = "select * from pos_pembelian where pembelian_id = ".QuoteValue(DPE_CHAR,$pembelianId);          $rs_edit = $dtaccess->Execute($sql);          $row_edit = $dtaccess->Fetch($rs_edit);          $dtaccess->Clear($rs_edit);                    $_POST["pembelian_nomer"] = $row_edit["pembelian_nomer"];          $_POST["pembelian_tanggal"] = format_date($row_edit["pembelian_tanggal"]);          $_POST["pembelian_toko"] = $row_edit["pembelian_toko"];               }	if($_x_mode=="New") $privMode = PRIV_CREATE;	elseif($_x_mode=="Edit") $privMode = PRIV_UPDATE;	else $privMode = PRIV_DELETE;         if ($_POST["btnNew"]) {          header("location: ".$_SERVER["PHP_SELF"]);          exit();     }        if ($_POST["btnDetail"]||$_POST["btnUpdate"]) {                               $dbTable = "pos_pembelian";                      $dbField[0] = "pembelian_id";   // PK           $dbField[1] = "pembelian_tanggal";           $dbField[2] = "pembelian_nomer";           $dbField[3] = "pembelian_toko";                                	           if(!$pembelianId) $pembelianId = $dtaccess->GetTransID();              $dbValue[0] = QuoteValue(DPE_CHAR,$pembelianId);           $dbValue[1] = QuoteValue(DPE_DATE,date_db($_POST["pembelian_tanggal"]));           $dbValue[2] = QuoteValue(DPE_CHAR,$_POST["pembelian_nomer"]);           $dbValue[3] = QuoteValue(DPE_CHAR,$_POST["pembelian_toko"]);                             	           $dbKey[0] = 0; // -- set key buat clause wherenya , valuenya = index array buat field / value           $dtmodel = new DataModel($dbTable,$dbField,$dbValue,$dbKey);           if ($_POST["btnDetail"]) {                $dtmodel->Insert() or die("insert  error");	                      } else if ($_POST["btnUpdate"]) {                $dtmodel->Update() or die("update  error");	           }                      unset($dtmodel);           unset($dbField);           unset($dbValue);           unset($dbKey);           //header("location:".$backPage);           //exit();                                 }       $tipe[0] = $view->RenderOption("--","Pilih Tipe",$show);	     if($_POST["item_tipe"]=="V") $show = "selected";     $tipe[1] = $view->RenderOption("V","Volume Based",$show);     unset($show);     if($_POST["item_tipe"]=="N") $show = "selected";     $tipe[2] = $view->RenderOption("N","Non Volume Based",$show);     unset($show);          //Tabel Detail Item                         //simpan Item     if ($_POST["btnSave"]) {     	                $sql = "select transaksi_saldo from pos_transaksi                    where id_item = ".QuoteValue(DPE_CHAR,$_POST["item_id"])."                     and id_dep = ".QuoteValue(DPE_CHAR,APP_OUTLET)."                      order by transaksi_create desc limit 1";                  $rs = $dtaccess->Execute($sql);       $stok = $dtaccess->Fetch($rs);         $stokSekarang = $stok["transaksi_saldo"]+$_POST["transaksi_jumlah"];             $dbTable = "pos_transaksi";                          $dbField[0] = "transaksi_id";   // PK               $dbField[1] = "transaksi_create";               $dbField[2] = "id_item";               $dbField[3] = "transaksi_jumlah";               $dbField[4] = "transaksi_tipe";               $dbField[5] = "transaksi_saldo";               $dbField[6] = "id_petugas";               $dbField[7] = "id_dep";               $dbField[8] = "transaksi_harga_beli";               $dbField[9] = "transaksi_harga_jual";               $dbField[10] = "transaksi_total";               $dbField[11] = "id_pembelian";                             			               if(!$transaksiId) $transaksiId = $dtaccess->GetTransID();                  $dbValue[0] = QuoteValue(DPE_CHAR,$transaksiId);               $dbValue[1] = QuoteValue(DPE_DATE,date("Y-m-d H:i:s"));               $dbValue[2] = QuoteValue(DPE_CHAR,$_POST["item_id"]);               $dbValue[3] = QuoteValue(DPE_NUMERIC,$_POST["transaksi_jumlah"]);               $dbValue[4] = QuoteValue(DPE_CHAR,'B');               $dbValue[5] = QuoteValue(DPE_NUMERIC,$stokSekarang);               $dbValue[6] = QuoteValue(DPE_NUMERIC,$userData["id"]);               $dbValue[7] = QuoteValue(DPE_CHAR,APP_OUTLET);               $dbValue[8] = QuoteValue(DPE_NUMERIC,StripCurrency($_POST["transaksi_harga_beli"]));               $dbValue[9] = QuoteValue(DPE_NUMERIC,0);               $dbValue[10] = QuoteValue(DPE_NUMERIC,StripCurrency($_POST["transaksi_total"]));               $dbValue[11] = QuoteValue(DPE_CHAR,$pembelianId);           	           $dbKey[0] = 0; // -- set key buat clause wherenya , valuenya = index array buat field / value           $dtmodel = new DataModel($dbTable,$dbField,$dbValue,$dbKey);           	if(!$updateData) {                 $dtmodel->Insert() or die("insert  error");	                      	} elseif($updateData) {                $dtmodel->Update() or die("update  error");	           }                      unset($dtmodel);           unset($dbField);           unset($dbValue);           unset($dbKey);           unset($updateData);                      unset($_POST["item_nama"]);           unset($_POST["transaksi_harga_beli"]);           unset($_POST["transaksi_jumlah"]);           unset($_POST["transaksi_total"]);            unset($_POST["transaksi_id"]);                       $dbTable = "pos_item";                        $dbField[0]  = "item_id";   // PK            $dbField[1]  = "item_jumlah";                          $dbValue[0] = QuoteValue(DPE_CHAR,$_POST["item_id"]);            $dbValue[1] = QuoteValue(DPE_NUMERIC,$stokSekarang);                          $dbKey[0] = 0; // -- set key buat clause wherenya , valuenya = index array buat field / value            $dtmodel = new DataModel($dbTable,$dbField,$dbValue,$dbKey);              $dtmodel->Update() or die("insert  error");	            unset($dbField);            unset($dbValue);                       //header("location:".$backPage);           //exit();                       }           if ($_POST["btnDelete"]) {          $transaksiId = & $_POST["cbDelete"];                    for($i=0,$n=count($transaksiId);$i<$n;$i++){               $sql = "select b.item_jumlah,a.transaksi_jumlah from pos_transaksi a                       join pos_item b on a.id_item=b.item_id                        where a.transaksi_id = ".QuoteValue(DPE_CHAR,$transaksiId[$i])."                       and id_dep = ".QuoteValue(DPE_CHAR,APP_OUTLET);                 $rs = $dtaccess->Execute($sql);               $stok = $dtaccess->Fetch($rs);                 $stokSekarang = $stok["item_jumlah"]-$stok["transaksi_jumlah"];                           $dbTable = "pos_item";                          $dbField[0]  = "item_id";   // PK              $dbField[1]  = "item_jumlah";                              $dbValue[0] = QuoteValue(DPE_CHAR,$_POST["item_id"]);              $dbValue[1] = QuoteValue(DPE_NUMERIC,$stokSekarang);                              $dbKey[0] = 0; // -- set key buat clause wherenya , valuenya = index array buat field / value              $dtmodel = new DataModel($dbTable,$dbField,$dbValue,$dbKey);                 $dtmodel->Update() or die("insert  error");	               unset($dbField);               unset($dbValue);                            $sql = "delete from pos_transaksi                         where transaksi_id = ".QuoteValue(DPE_CHAR,$transaksiId[$i]);               $dtaccess->Execute($sql);                              unset($dtmodel);               unset($dbField);               unset($dbValue);               unset($dbKey);                              unset($_POST["item_nama"]);               unset($_POST["transaksi_harga_beli"]);               unset($_POST["transaksi_jumlah"]);               unset($_POST["transaksi_total"]);                         }      }          if ($_POST["btnDeletePembelian"]) {         $pembelianId = & $_POST["cbDeletePembelian"];         for($i=0,$n=count($pembelianId);$i<$n;$i++){         $sql = "select * from pos_transaksi             where id_pembelian = ".QuoteValue(DPE_CHAR, $pembelianId[$i]);                   //echo $sql;         $rs_edit = $dtaccess->Execute($sql);                  $dataTransaksi = $dtaccess->FetchAll($rs_edit);                   if ($dataTransaksi)          {            //echo "masuk jeng";           header("location:".$backPageGagal);           exit();          } else {                         $sql = "delete from pos_pembelian                         where pembelian_id = ".QuoteValue(DPE_CHAR,$pembelianId[$i]);             $dtaccess->Execute($sql);          header("location:".$backPage);          exit();              }                 }       }               if ($_POST["btnSave"]||$_POST["btnDelete"]||$_POST["btnUpdate"]) {       $sql = "select *,b.item_nama from pos_transaksi a             join pos_item b on a.id_item=b.item_id              where a.id_pembelian = ".QuoteValue(DPE_CHAR, $pembelianId)."             order by a.transaksi_create desc";     $rs_edit = $dtaccess->Execute($sql);     $dataTable = $dtaccess->FetchAll($rs_edit);     $tableHeader = "&nbsp;Detail Item Pembelian";          $isAllowedDel = $auth->IsAllowed("pos_pembelian",PRIV_DELETE);     $isAllowedUpdate = $auth->IsAllowed("pos_pembelian",PRIV_UPDATE);     $isAllowedCreate = $auth->IsAllowed("pos_pembelian",PRIV_CREATE);          // --- construct new table ---- //     $counterHeader = 0;     if($isAllowedDel){          $tbHeader[0][$counterHeader][TABLE_ISI] = "<input type=\"checkbox\" onClick=\"EW_selectKey(this,'cbDelete[]');\">";          $tbHeader[0][$counterHeader][TABLE_WIDTH] = "3%";          $counterHeader++;     }          if($isAllowedUpdate){          $tbHeader[0][$counterHeader][TABLE_ISI] = "Edit";          $tbHeader[0][$counterHeader][TABLE_WIDTH] = "7%";          $counterHeader++;     }               $tbHeader[0][$counterHeader][TABLE_ISI] = "Item";     $tbHeader[0][$counterHeader][TABLE_WIDTH] = "10%";          $counterHeader++;          $tbHeader[0][$counterHeader][TABLE_ISI] = "Harga";     $tbHeader[0][$counterHeader][TABLE_WIDTH] = "20%";          $counterHeader++;          $tbHeader[0][$counterHeader][TABLE_ISI] = "Jumlah";     $tbHeader[0][$counterHeader][TABLE_WIDTH] = "10%";          $counterHeader++;          $tbHeader[0][$counterHeader][TABLE_ISI] = "Total";     $tbHeader[0][$counterHeader][TABLE_WIDTH] = "10%";          $counterHeader++;               for($i=0,$counter=0,$n=count($dataTable);$i<$n;$i++,$counter=0){          if($isAllowedDel) {               $tbContent[$i][$counter][TABLE_ISI] = '<input type="checkbox" name="cbDelete[]" value="'.$dataTable[$i]["transaksi_id"].'">';                              $tbContent[$i][$counter][TABLE_ALIGN] = "center";               $counter++;          }                   if($isAllowedUpdate) {               $tbContent[$i][$counter][TABLE_ISI] = '<a href="#" onClick="EditItem(\''.$dataTable[$i]["transaksi_id"].'\',\''.$dataTable[$i]["item_nama"].'\',\''.$dataTable[$i]["item_id"].'\',\''.$dataTable[$i]["transaksi_harga_beli"].'\',\''.$dataTable[$i]["transaksi_jumlah"].'\',\''.$dataTable[$i]["transaksi_total"].'\')"><img hspace="2" width="16" height="16" src="'.$APLICATION_ROOT.'images/b_edit.png" alt="Edit" title="Edit" border="0"></a>';                              $tbContent[$i][$counter][TABLE_ALIGN] = "center";               $counter++;          }                    $tbContent[$i][$counter][TABLE_ISI] = $dataTable[$i]["item_nama"];           $tbContent[$i][$counter][TABLE_ALIGN] = "center";          $counter++;                    $tbContent[$i][$counter][TABLE_ISI] = currency_format($dataTable[$i]["transaksi_harga_beli"]);          $tbContent[$i][$counter][TABLE_ALIGN] = "right";          $counter++;                    $tbContent[$i][$counter][TABLE_ISI] = $dataTable[$i]["transaksi_jumlah"];          $tbContent[$i][$counter][TABLE_ALIGN] = "right";          $counter++;                    $tbContent[$i][$counter][TABLE_ISI] = currency_format($dataTable[$i]["transaksi_total"]);          $tbContent[$i][$counter][TABLE_ALIGN] = "right";          $counter++;          $totalHarga+=$dataTable[$i]["transaksi_total"];          $colspan = count($tbHeader[0]);          if($isAllowedDel) {			$tbBottom[0][0][TABLE_ISI] = '&nbsp;&nbsp;<input type="submit" name="btnDelete" value="Hapus" class="button">&nbsp;';		}     $tbBottom[0][0][TABLE_WIDTH] = "100%";     $tbBottom[0][0][TABLE_COLSPAN] = $colspan-1;           $tbBottom[0][1][TABLE_ISI] = currency_format($totalHarga);     $tbBottom[0][1][TABLE_ALIGN] = "right";     }      }        ?><?php echo $view->RenderBody("inventori.css",true); ?><?php echo $view->InitThickBox(); ?> <script language="javascript" type="text/javascript"><? $plx->Run(); ?>function GantiHarga(harga) {     var duit = document.getElementById('transaksi_harga_beli').value.toString().replace(/\,/g,"");     document.getElementById('transaksi_total').value = formatCurrency(duit*harga);}function CheckDataSave(frm){     		if(!frm.pembelian_nomer.value){		alert('Nomer Pembelian Harus Diisi');		frm.pembelian_nomer.focus();          return false;	}			if(!frm.pembelian_tanggal.value){		alert('Tanggal Harus Diisi');		frm.pembelian_tanggal.focus();          return false;	}			if(!frm.pembelian_toko.value){		alert('Toko tempat pembelian Harus Diisi');		frm.pembelian_toko.focus();          return false;	}		return true;          }function CheckDataSave(frm){    var duit = document.getElementById('transaksi_harga_beli').value.toString().replace(/\,/g,"");  var harga = document.getElementById('transaksi_jumlah').value.toString().replace(/\,/g,"");       		if(!frm.item_nama.value){		alert('Item Harus Dipilih');		frm.item_nama.focus();          return false;	}		if(!frm.transaksi_harga_beli.value){		alert('Harga Beli Harus Diisi');		frm.transaksi_harga_beli.focus();          return false;	}		if(!frm.transaksi_jumlah.value){		alert('Jumlah Harus Diisi');		frm.transaksi_jumlah.focus();          return false;	}		if(!frm.transaksi_total.value){		alert('Total Pembelian Harus Ada');		frm.transaksi_total.focus();          return false;	}			  document.getElementById('transaksi_total').value = formatCurrency(duit*harga);		return true;          }function formatCurrency(num) {/* Strip commas before processing */num = num.toString().replace(/\,/g,"");var akhir = num.toString().charAt(num.toString().length-1);/* Round to two decimal places if longer */num = !isNaN(num) ? Math.round(num * 100) / 100 : 0;if(akhir == '.') num = num.toString() + '.';/* Add decimal and zeroes if none exist *///num.toString().indexOf(".") == -1 ? num += ".00" : void 0;/* Add zeroes if only decimal exists or only one digit after decimal *///while(/\.\d{0,1}$/.test(num)) num += "0";/* Add commas */var objRegExp = new RegExp('(-?\[0-9]+)([0-9]{3})');while(objRegExp.test(num)) num = num.toString().replace(objRegExp,'$1,$2');/* Return formatted currency */return num;}function EditItem(id,nama,id_item,harga,jumlah,total) { 	document.getElementById('transaksi_id').value = id;	document.getElementById('item_nama').value = nama;	document.getElementById('item_id').value = id_item;	document.getElementById('transaksi_harga_beli').value = formatCurrency(harga);	document.getElementById('transaksi_jumlah').value = jumlah;	document.getElementById('transaksi_total').value = formatCurrency(total); 	document.getElementById('transaksi_harga_beli').focus();} </script><table width="100%" border="0" cellpadding="1" cellspacing="1">    <tr class="tableheader">        <td width="100%">&nbsp;Setup Item</td>    </tr></table><form name="frmEdit" method="POST" action="<?php echo $_SERVER["PHP_SELF"]?>"><table width="60%" border="0" cellpadding="1" cellspacing="1"><tr>     <td>     <fieldset>     <legend><strong>Pembelian Mini POS</strong></legend>     <table width="100%" border="0" cellpadding="1" cellspacing="1">          <tr>               <td align="right" class="tablecontent" width="20%"><strong>Nomer</strong>&nbsp;</td>               <td width="80%">				            <?php echo $view->RenderTextBox("pembelian_nomer","pembelian_nomer","60","100",$_POST["pembelian_nomer"],"inputField", null,false);?>                                                      </td>          </tr>          <tr>               <td align="right" class="tablecontent"><strong>Tanggal</strong>&nbsp;</td>               <td>                    <?php echo $view->RenderTextBox("pembelian_tanggal","pembelian_tanggal","15","30",$_POST["pembelian_tanggal"],"inputField", "readonly",null,false);?>                    <img src="<?php echo $APLICATION_ROOT;?>images/b_calendar.png" width="16" height="16" align="middle" id="img_pembelian_tanggal" style="cursor: pointer; border: 0px solid white;" title="Date selector" onMouseOver="this.style.background='red';" onMouseOut="this.style.background=''" />               </td>          </tr>          <tr>               <td align="right" class="tablecontent"><strong>Toko</strong>&nbsp;</td>               <td>                    <?php echo $view->RenderTextBox("pembelian_toko","pembelian_toko","40","60",$_POST["pembelian_toko"],"inputField", null,false);?>               </td>          </tr>          <?php if (!$_POST["btnDetail"]&&!$_POST["btnUpdate"]&&!$_POST["btnSave"]&&!$_POST["btnDelete"]) { ?>           <tr>               <td colspan="2" align="right">                    <?php echo $view->RenderButton(BTN_SUBMIT,($_x_mode == "Edit")?"btnUpdate":"btnDetail","btnDetail",($_x_mode == "Edit")?"Rubah Pembelian":"Masukkan Item","button",false,"onClick=\"javascript:return CheckDataSave(this.form);\"");?>                    <?php echo $view->RenderButton(BTN_BUTTON,"btnBack","btnBack","Kembali","button",false,"onClick=\"document.location.href='pembelian_view.php';\"");?>                                   </td>          </tr>          <?php } ?>     </table>     </fieldset>     </td></tr></table><input type="hidden" name="pembelian_id" id="pembelian_id" value="<?php echo $pembelianId;?>" /><?php if ($_POST["btnDetail"]||$_POST["btnUpdate"]||$_POST["btnSave"]||$_POST["btnDelete"]) {  ?><table width="60%" border="0" cellpadding="1" cellspacing="1"><tr>     <td>     <fieldset>     <legend><strong>Detail Item</strong></legend>     <table width="100%" border="0" cellpadding="1" cellspacing="1">     <tr> 			 <td> 				<table width="100%">           <tr>               <td align="right" class="tablecontent" width="20%"><strong>Item</strong>&nbsp;</td>               <td width="80%">				            <?php echo $view->RenderTextBox("item_nama","item_nama","30","100",$_POST["item_nama"],"inputField", "readonly",false);?>                      <a href="<?php echo $findPage;?>&TB_iframe=true&height=400&width=450&modal=true" class="thickbox" title="Pilih Item"><img src="<?php echo $APLICATION_ROOT;?>images/b_select.png" border="0" align="middle" width="18" height="20" style="cursor:pointer" title="Pilih Item" alt="Pilih Item" /></a>                       <input type="hidden" name="item_id" id="item_id" value="<?php echo $_POST["item_id"];?>" />                    <input type="hidden" name="item_harga_jual" id="item_harga_jual" value="<?php echo $_POST["item_harga_jual"];?>" />                    <input type="hidden" name="item_harga_beli" id="item_harga_beli" value="<?php echo $_POST["item_harga_beli"];?>" />                        <input type="hidden" name="transaksi_id" id="transaksi_id" value="<?php echo $_POST["transaksi_id"];?>" />                                                       </td>          </tr>          <tr>               <td align="right" class="tablecontent"><strong>Harga</strong>&nbsp;</td>               <td>                    <?php echo $view->RenderTextBox("transaksi_harga_beli","transaksi_harga_beli","20","40",currency_format($_POST["transaksi_harga_beli"]),"inputField", null,true);?>               </td>          </tr>          <tr>               <td align="right" class="tablecontent"><strong>Jumlah</strong>&nbsp;</td>               <td>                    <?php echo $view->RenderTextBox("transaksi_jumlah","transaksi_jumlah","10","20",$_POST["transaksi_jumlah"],"inputField", null,true,'onChange=GantiHarga(this.value)');?>               </td>          </tr>          <tr>               <td align="right" class="tablecontent"><strong>Total</strong>&nbsp;</td>               <td>                    <?php echo $view->RenderTextBox("transaksi_total","transaksi_total","30","50",currency_format($_POST["transaksi_total"]),"inputField","readonly", null,true);?>               </td>          </tr>          <tr>               <td colspan="2" align="right">                    <?php echo $view->RenderButton(BTN_SUBMIT,"btnSave","btnSave","Simpan","button",false,"onClick=\"javascript:return CheckItemSave(this.form);\"");?>                    <?php echo $view->RenderButton(BTN_BUTTON,"btnBack","btnBack","Kembali","button",false,"onClick=\"document.location.href='pembelian_view.php';\"");?>                                   </td>          </tr>          </table>							</td>						</tr>						<tr>							<td>&nbsp;							</td>						</tr> 						<tr> 							<td>								<span id="div_item">									<?php echo $table->RenderView($tbHeader,$tbContent,$tbBottom); ?>								</span>							</td>						</tr>               </table>     </fieldset>     </td></tr></table><? } ?><script type="text/javascript">    Calendar.setup({        inputField     :    "pembelian_tanggal",      // id of the input field        ifFormat       :    "<?=$formatCal;?>",       // format of the input field        showsTime      :    false,            // will display a time selector        button         :    "img_pembelian_tanggal",   // trigger for the calendar (button ID)        singleClick    :    true,           // double-click mode        step           :    1                // show all years in drop-down boxes (instead of every other year as default)    });</script></form><?php echo $view->RenderBodyEnd(); ?>